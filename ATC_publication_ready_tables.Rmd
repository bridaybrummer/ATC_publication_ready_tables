---
author: the National Institute for Communicable Diseases
output:
  bookdown::word_document2:
    pandoc_args:
#    - "--filter=pandoc-crossref"
#    - "--reference-doc=Extras/June-report_working_reference.docx"
    - "--reference-doc=Extras/NMC_reference.docx"
#    - "--lua-filter=extras/scholarly-metadata.lua"
#    - "--lua-filter=extras/author-info-blocks.lua"
#   - "--variable=geometry:\"[portrait,landscape]\""
    fig_caption: true
    number_sections: true
    toc: false
    toc_depth: 2
    date:
      format: '%Y%m%d'
#    toc: yes

title: "NOTIFIABLE MEDICAL CONDITIONS SURVEILLANCE SYSTEM"
always_allow_html: true
---

```{r setup, include=FALSE}

# Install pacman if not already installed
if (!requireNamespace("pacman", quietly = TRUE)) {
  install.packages("pacman")
}

# Load pacman
library(pacman)

# Use pacman to install and load packages
p_load(
  sf,
  readxl,
  tidyverse,
  dplyr,
  ggplot2,
  knitr,
  tinytex,
#  haven,
  janitor,
#  summarytools,
#  lubridate,
  grates,
#  forcats,
  magrittr,
  gtsummary, 
  flextable,
  officer,
  kableExtra
#  RecorLinkage,
# openai,
#  DescTools
)


# this removes objects in the environemtn and 
#rm(list = ls())
# and clears space
#gc()

# set flextable defaults
flextable::set_flextable_defaults(
  font.family = "Century Gothic", 
  font.size = 8, 
  header.font.size = 9,
  border.color = "black")



# set gtsummary defaults
gtsummary::theme_gtsummary_language(language = "en",
                                    big.mark = " ", 
                                    decimal.mark = ".")

# set rmakrdwon outputs
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%", dpi = 300, fig.width=7)

# this is a fucntion to remove the first blank column of a gtsummary object. 
trim_tbl <- function(gt_summary_object) {
  length_table_body <- gt_summary_object$table_body %>% nrow()
  gt_summary_object$table_body <- gt_summary_object$table_body[2:length_table_body, ]
  return(gt_summary_object)
}

library(kableExtra)
# Replace the URL with your desired hyperlink
tidyverse_url <- "https://www.tidyverse.org/packages/"

gtsummary_url <- "https://www.danieldsjoberg.com/gtsummary/"

flextable_url <- "https://ardata-fr.github.io/flextable-book/"

ggplot_url <- "https://ggplot2.tidyverse.org/"

NMCSS_url <- "https://www.nicd.ac.za/nmc-overview/nmc-monthly-surveillance-report/"

```

# Introduction {.unnumbered}

R markdown is a simple and easy to use plain text language used to combine your R code, results from your data analysis (including plots and tables) and written commentary into a single nicely formatted and reproducible document (like a report, publication, thesis chapter or a web page like this one). There is also quarto which is a next generation Rmarkdown which can handle multiple languages and is slightly faster, however it does not handle some outputs to word as well Rmarkdown (like figure and table cross referencing) although it will likely handle these in future updates.

# Purpose  {.unnumbered}

The purpose of this session (and document) is to show you how to produce some publication ready tables and publish it to a word document (.docx)  from Rmarkdown. 
We will mainly be using tools from the [tidyverse](`r tidyverse_url`), [gtsummary](`r gtsummary_url`), [flextable](`r flextable_url`), and [ggplot2](`r ggplot_url`) packages. 

# Methods

A selection of code chunks will be given with built in data sets to run. Then a dataset will be given to import and and code chunks to run that are similar to the Monthly [NMCSS Surveillance](`r NMCSS_url`) report. 

\newpage

```{r, tab-first, fig.cap = ""}

first<- trial %>%
  tbl_summary()

first%>%  as_flex_table %>%
  flextable::set_caption("The first summary table caption")

```

See the Table \@ref(tab:tab-first) for the first output. We can also get values from the table, for instance, the median(IQR) age is `r inline_text(first, variable = age)`.

\newpage


```{r, tab-second, fig.cap = ""}

trial %>%tbl_summary(by = trt) %>%as_flex_table %>%flextable::set_caption("The second summary table caption")

```


See \@ref(tab:tab-second)to see the second output of the session. 

\newpage


```{r, tab-stats, fig.cap = ""}

trial %>%tbl_summary(by = trt) %>%
  add_p%>%
  add_overall%>%
  add_ci%>%
  as_flex_table %>%flextable::set_caption("The second summary table caption")

```


\newpage 

```{r, tab-regression, fig.cap = ""}

glm(death ~ trt+ age + marker + stage + grade+ response, data = trial)%>%
  tbl_regression(., exponentiate = TRUE)%>%
  as_flex_table %>%
  flextable::set_caption("The regression summary table caption")

```

\newpage 

We can also make a plot:

```{r, figure, fig.cap = ""}

nmc<- readxl::read_excel("december_ATC_practice.xlsx")

category <- 2

dot_nmc1<-nmc%>%
  filter(nmccategories == category, !is.na(prov_)) %>%
  ggplot(., aes(x = prov_, y = condition, color = condition)) +
  geom_count(show.legend = FALSE) +
  scale_size_area(max_size = 15)+
  labs(title = paste0("Notifications of category ", category, " within Each Province"),
       x = "Province", y = "Condition") +
  theme_minimal() +
  #  scale_color_brewer(palette = "Set1")+
  scale_color_viridis_d( option = "C") +
  theme(text = element_text(family = "Century Gothic", size = 12, color = "#333333"),
        panel.background = element_rect(fill = "#F8F8F8"),
        plot.background = element_rect(fill = "#F8F8F8"),
        panel.grid = element_line(color = "#DDDDDD"),
        legend.background = element_rect(fill = "#F8F8F8"),
        legend.text = element_text(color = "#333333"),
        legend.title = element_text(color = "#333333", size = 10),
        plot.title = element_text(size = 16, #face = "bold",
                                  color = "#666666"),
        plot.subtitle = element_text(size = 12, color = "#666666"),
        plot.caption = element_text(size = 10, color = "#666666"),
        legend.position = "bottom",
        legend.direction = "vertical",
        legend.key = element_blank()
        #legend.title = element_blank()
  ) +
  guides(color = guide_legend(nrow = 10))

dot_nmc1
```

\newpage 

```{r nmc-table}

case_def_labs<- nmc$case_definition%>%unique

cat_1_glance<- nmc%>%
  filter(nmccategories ==1)%>%
  dplyr::select(condition , case_definition)%>%
  tbl_summary(by = case_definition, 
              percent = "row", 
              statistic = list(all_categorical() ~ "{n}") )%>%
  add_overall("after", statistic = ~"{n}")%>%
  modify_header(label = "**Condition**",
                all_stat_cols() ~ "**{level}**, \n N = {n}")%>%
  
  trim_tbl()%>%
  modify_footnote(update = everything() ~ NA
                  ) %>% modify_footnote(all_stat_cols() ~ "Suspected and confirmed cases are independent and are not totalled - suspected and confirmed cases are distinct.") 


cat_1_glance%>%as_flex_table%>%
   flextable::set_caption("The number of notifications that are suspected and confirmed for category 1 conditions.") %>%# Example: making the first row (header) bold
    fontsize(., size = 9, part = "header")%>%
  flextable::set_table_properties(layout = "autofit", width = 0.99)
```



```{r notifications_map, include=TRUE}


as_excel <- function(.) {
  . +
    theme_minimal() +
    #scale_x_date(date_labels = "%b \n '%y", date_breaks = "6 months", limits = c(min, max)) +
    #scale_color_viridis_d(option = "B") +
    theme(
      text = element_text(family = "Century Gothic", 
                          size = 12, color = "#333333"),
      panel.background = element_rect(fill = "#F8F8F8"),
      plot.background = element_rect(fill = "#F8F8F8"),
      panel.grid = element_line(color = "#DDDDDD"),
      legend.background = element_rect(fill = "#F8F8F8"),
      legend.text = element_text(color = "#333333"),
      legend.title = element_text(color = "#333333", size = 10),
      plot.title = element_text(size = 16, color = "#666666"),
      plot.subtitle = element_text(size = 12, color = "#666666"),
      plot.caption = element_text(size = 10, color = "#666666"),
      #legend.position = "right",
      #legend.direction = "vertical",
      #legend.key = element_blank(),
      axis.text.x = element_text(angle = 30)
    ) #+
  #guides(color = guide_legend(nrow = 7, size = 0.2))
}


source("gg2word.R")

df<- nmc
source("map.R")

prov_shape<- subdist_shape %>% 
  group_by(ADM1_ID) %>%
  summarise(geometry = sf::st_union(geometry)) %>%
  ungroup()


# Extract unique district names from your data frame
provinces <- df$prov_ %>% unique()

# Prepare the data for plotting
df_shape_measles <- df %>% 
  #filter(condition %in% "Measles")%>% # you can subset into different conditions 
  group_by(ADM1_ID = prov_) %>%
  summarise(Notifications = n()) %>% 
  mutate(ADM1_ID = factor(ADM1_ID, levels = provinces))%>%
  filter(!is.na(ADM1_ID))

# Merge shape data with your summary data
shape_data <-fuzzyjoin::stringdist_inner_join(prov_shape, df_shape_measles, by = "ADM1_ID", method = "jw", distance_col = "string_dist")%>%
  group_by(ADM1_ID.x) %>%filter( string_dist == min(string_dist))%>%
  mutate(text = paste0( ADM1_ID.y, "\nn=", ifelse(is.na(Notifications), 0, Notifications)))%>%
  rename(ADM1_ID = ADM1_ID.y)

# Plot the map using ggplot2
map_notifications<- ggplot(data = shape_data) +
  geom_sf( aes(fill = Notifications)) +
  geom_sf_label(aes(label = text), size = 3) + 
  scale_fill_gradient(low = "lightyellow", high = "#f46d43") +  # Customize fill color gradient
  labs(#title = #"Covid Cases in Free State Districts",       # Add a title
    fill = "Number of notifications",                           # Legend title for fill color
    #caption = "Source: Your Data Source"
  ) +             # Caption/source information
  theme(text = element_text(family = "Century Gothic"))+
  theme_classic() %>%as_excel()                # Use a minimal theme for the plot

save(map_notifications, file = "plots/map_notifications.rda")

gg2word(map_notifications, directory_name = "plots")


```

```{r}


as_epicurve_excel <- function(.) {

  . +
    theme_minimal() +
    scale_color_viridis_d(option = "A") +
    theme(
      text = element_text(family = "Century Gothic", 
                          size = 12, color = "#333333"),
      panel.background = element_rect(fill = "#F8F8F8"),
      plot.background = element_rect(fill = "#F8F8F8"),
      panel.grid.major = element_line(color = "#DDDDDD"),
      panel.grid.minor = element_line(colour = NA),
      legend.background = element_rect(fill = "#F8F8F8"),
      legend.text = element_text(color = "#333333"),
      legend.title = element_text(color = "#333333", size = 10),
      plot.title = element_text(size = 16, color = "#666666"),
      plot.subtitle = element_text(size = 12, color = "#666666"),
      plot.caption = element_text(size = 10, color = "#666666"),
      #legend.position = "right",
      #legend.direction = "vertical",
      #legend.key = element_blank(),
      axis.text.x = element_text(angle = 30, size = 8)
    ) #+
  #guides(color = guide_legend(nrow = 7, size = 0.2))
}

salmonella <- read_excel("Salmonella.xlsx")

salmonella<- salmonella %>%clean_names

names(salmonella)

colSums(is.na(salmonella))

salmonella$collectdte
xtabs(~ gender, data = salmonella)

salmonella1<- salmonella %>%mutate(
  notification_date = as_date(collectdte, format = "%d/%m/%Y"), 
  gender = ifelse(grepl("female", ignore.case = TRUE, gender), "Female", "Male")
)

salmonella1$collectdte
xtabs(~ gender, data = salmonella1)
tabyl(dat  =salmonella, gender)

df1<-salmonella1

#source("epicurve.R")
  min <- min(df1$notification_date) # to be used in a function 
  max<- max(df1$notification_date)
  
epicurve<- df1 %>%filter(
  #condition %in% "Measles"
)%>%mutate(
       date = as_date(notification_date), 
       year = as_year(notification_date), 
       month = as_date(as_yearmonth(as_date(notification_date))),
       epiweek =as_date( as_epiweek(notification_date))
       )%>%
  group_by(epiweek, year, date, month, gender #this var an be anythign you want to group_by
           )%>%
  summarise(n = n())%>%
  ggplot(.,)+
  geom_bar(  aes(x =epiweek, y = n , fill = gender), stat = "identity",#c("darkolivegreen")
             )+
  #geom_line( aes(x =epiweek, y = n  ))
  scale_x_date(date_labels = "%b", 
               date_breaks = "1 month", 
               limits = c(min(df1$notification_date), max(df1$notification_date)))+
  labs( title = "Epicurve of Measles notifications", 
        fill = "Case Definition",
        x = "Epiweek Date of Notification",
        y = "Notifications (n)"
  )



my_colors <- c("#78c693", "#f46d43")  

epicurve<-epicurve+scale_fill_manual(values = my_colors)

epicurve<- epicurve%>%as_epicurve_excel()

save(epicurve, file = "plots/epicurve.rda")

gg2word(epicurve, directory_name = "plots")

```

# Make a descriptive table of the salmonella dataset. 




